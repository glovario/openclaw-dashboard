name: PR Dashboard Sync

on:
  pull_request:
    types: [opened, reopened]

jobs:
  sync-to-dashboard:
    runs-on: ubuntu-latest
    steps:
      - name: Sync PR to OpenClaw Dashboard
        env:
          DASHBOARD_API_KEY: ${{ secrets.DASHBOARD_API_KEY }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          DASHBOARD_BASE_URL: http://192.168.1.124:3420
        run: |
          # Search for existing task matching PR title
          ENCODED_TITLE=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$PR_TITLE'))")
          SEARCH_RESPONSE=$(curl -s -w "\n%{http_code}" \
            -H "X-API-Key: $DASHBOARD_API_KEY" \
            "$DASHBOARD_BASE_URL/api/tasks?search=$ENCODED_TITLE")

          HTTP_CODE=$(echo "$SEARCH_RESPONSE" | tail -1)
          BODY=$(echo "$SEARCH_RESPONSE" | head -n -1)

          echo "Search response code: $HTTP_CODE"

          if [ "$HTTP_CODE" = "200" ]; then
            TASK_ID=$(echo "$BODY" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          tasks = data if isinstance(data, list) else data.get('tasks', data.get('data', []))
          if tasks:
              print(tasks[0]['id'])
          ")
          fi

          if [ -n "$TASK_ID" ]; then
            echo "Found existing task: $TASK_ID — patching with PR URL and status=review"
            curl -s -X PATCH \
              -H "X-API-Key: $DASHBOARD_API_KEY" \
              -H "Content-Type: application/json" \
              -d "{\"github_url\": \"$PR_URL\", \"status\": \"review\"}" \
              "$DASHBOARD_BASE_URL/api/tasks/$TASK_ID"
          else
            echo "No matching task found — creating new task"
            curl -s -X POST \
              -H "X-API-Key: $DASHBOARD_API_KEY" \
              -H "Content-Type: application/json" \
              -d "{
                \"title\": \"$PR_TITLE\",
                \"github_url\": \"$PR_URL\",
                \"owner\": \"mason\",
                \"status\": \"review\",
                \"priority\": \"medium\",
                \"effort\": \"unknown\"
              }" \
              "$DASHBOARD_BASE_URL/api/tasks"
          fi
